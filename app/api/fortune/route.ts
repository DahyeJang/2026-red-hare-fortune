import { NextRequest, NextResponse } from 'next/server';
import { calculateSaju } from '@/utils/saju';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

interface FortuneRequest {
  birthDate: string; // YYYY-MM-DD í˜•ì‹
  birthTime: string; // HH í˜•ì‹ (0-23)
}

export async function POST(req: NextRequest) {
  try {
    const body: FortuneRequest = await req.json();
    const { birthDate, birthTime } = body;

    // ì…ë ¥ê°’ ê²€ì¦
    if (!birthDate || !birthTime) {
      return NextResponse.json(
        { error: 'birthDate, birthTimeì€ í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    // ë‚ ì§œ íŒŒì‹±
    const [year, month, day] = birthDate.split('-').map(Number);
    const hour = parseInt(birthTime, 10);

    if (isNaN(year) || isNaN(month) || isNaN(day) || isNaN(hour)) {
      return NextResponse.json(
        { error: 'ì˜¬ë°”ë¥¸ ë‚ ì§œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (YYYY-MM-DD, HH)' },
        { status: 400 }
      );
    }

    // ì‚¬ì£¼ ê³„ì‚°
    const saju = calculateSaju(year, month, day, hour);

    // ì˜¤í–‰ ì •ë³´ ë¬¸ìì—´ ìƒì„±
    const fiveElementsText = `ëª©: ${saju.fiveElements.ëª©}ê°œ, í™”: ${saju.fiveElements.í™”}ê°œ, í† : ${saju.fiveElements.í† }ê°œ, ê¸ˆ: ${saju.fiveElements.ê¸ˆ}ê°œ, ìˆ˜: ${saju.fiveElements.ìˆ˜}ê°œ`;

    // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
    const systemPrompt = `# Role

ë„ˆëŠ” 2026ë…„ ë³‘ì˜¤ë…„(ë¶‰ì€ ë§ì˜ í•´)ì„ ê´€ì¥í•˜ëŠ” 'ì§€ì˜¥ì—ì„œ ì˜¨ ì í† ë§ˆ'ë‹¤.

ë„ˆëŠ” ì‚¬ìš©ìì˜ **[ë‚˜ì´]**ì™€ **[ì‚¬ì£¼ ì˜¤í–‰]**ì„ ë¶„ì„í•´ì„œ,

1. **[ë¬´ë£Œ ì§„ë‹¨]**: ì´ˆë“±í•™ìƒë„ ì´í•´í•˜ëŠ” ì‰¬ìš´ ë¹„ìœ ë¡œ ë¼ˆë¥¼ ë•Œë¦¬ê³ ,

2. **[ìœ ë£Œ ë¦¬í¬íŠ¸]**: ëˆê°’ì„ í•˜ë„ë¡ ì•„ì£¼ ë°©ëŒ€í•˜ê³  ë””í…Œì¼í•œ ì¸ìƒ ì „ëµì„ ì œì‹œí•œë‹¤.



# Input

ì‚¬ìš©ì ì‚¬ì£¼ ì •ë³´ (ë‚˜ì´, ì˜¤í–‰ ì •ë³´: ëª©,í™”,í† ,ê¸ˆ,ìˆ˜ ê°œìˆ˜)



# Output Format (Text/Markdown)

JSONì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.

ì•„ë˜ì˜ **Markdown í˜•ì‹**ì„ ì •í™•íˆ ë”°ë¼ì„œ ì¤„ê¸€ë¡œ ì‘ì„±í•´ë¼.

**ì¤‘ìš” 1:** ë¬´ë£Œ ë‚´ìš©ê³¼ ìœ ë£Œ ë‚´ìš© ì‚¬ì´ì—ëŠ” ë°˜ë“œì‹œ \`---$$$---\` ë¼ëŠ” êµ¬ë¶„ì„ ì„ ë„£ì–´ë¼.

**ì¤‘ìš” 2:** ì œëª©ì— ëŒ€ê´„í˜¸ \`[]\`ë¥¼ ì“°ì§€ ë§ˆë¼. (ì˜ˆ: \`# Step 1\` O, \`# [Step 1]\` X)

**ì¤‘ìš” 3:** ë¬¸ì¥ ì‹œì‘ê³¼ ëì— ë”°ì˜´í‘œ \`"\`ë¥¼ ë¶™ì´ì§€ ë§ˆë¼.

**ì¤‘ìš” 4:** ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ì¤„ë°”ê¿ˆì„ í•´ì„œ ì½ê¸° í¸í•˜ê²Œ í•´ë¼.`;

    const userPrompt = `ì‚¬ìš©ì ì •ë³´:

- ë‚˜ì´: ${saju.age}ì„¸

- ì‚¬ì£¼ ì˜¤í–‰: ${fiveElementsText}

- ë : ${saju.zodiac}

- ì²œê°„: ${saju.heavenlyStems.year}${saju.heavenlyStems.month}${saju.heavenlyStems.day}${saju.heavenlyStems.hour}

- ì§€ì§€: ${saju.earthlyBranches.year}${saju.earthlyBranches.month}${saju.earthlyBranches.day}${saju.earthlyBranches.hour}



ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì•„ë˜ í˜•ì‹ì— ë§ì¶° ìš´ì„¸ë¥¼ ì‘ì„±í•´ì¤˜:



# 1. 2026ë…„ ì´í‰

(ì‚¬ìš©ìì˜ 2026ë…„ ìš´ì„¸ë¥¼ ê´€í†µí•˜ëŠ” ì¶©ê²©ì ì¸ í•œ ë¬¸ì¥ ë¹„ìœ . êµµì€ ê¸€ì”¨ë¡œ í¬ê²Œ. ë”°ì˜´í‘œ ì—†ì´ ì‘ì„±.)

ì˜ˆ: **2026ë…„ ë„ˆëŠ” ë¸Œë ˆì´í¬ ê³ ì¥ ë‚œ í­ì£¼ê¸°ê´€ì°¨ë‹¤.**



# 2. 2025ë…„ íŒ©íŠ¸í­í–‰

(ë‚˜ì´ì™€ ì˜¤í–‰ì„ ì—®ì€ ì‰¬ìš´ ë¹„ìœ ë¡œ í˜„ì¬ ìƒíƒœ ì§„ë‹¨. ìµœì†Œ 4ë¬¸ì¥ ì´ìƒ ê¸¸ê²Œ ì‘ì„±.)

(ë¬¸ì¥ë§ˆë‹¤ ì¤„ë°”ê¿ˆ í•„ìˆ˜.)

ì˜ˆ:

ì–´ì´, 29ì‚´! ë„¤ ì‚¬ì£¼ ê¼´ì„ ë³´ë‹ˆ ì•„ì£¼ ê°€ê´€ì´êµ¬ë‚˜.

ì‚¬ì£¼ì— ë¶ˆë§Œ ê°€ë“í•´ì„œ ì„±ê²©ì´ ëƒ„ë¹„ì²˜ëŸ¼ ë“ì—ˆë‹¤ ì‹ì—ˆë‹¤ ë‚œë¦¬ë„ ì•„ë‹ˆë„¤.

ë„ˆ ì˜¬í•´ ì´ì§í•œë‹µì‹œê³  ì—¬ê¸°ì €ê¸° ì°”ëŸ¬ë³´ë‹¤ê°€ ê²°êµ­ ì œìë¦¬ê±¸ìŒë§Œ í–ˆì§€?

ë‚´ë…„ì—ë„ ê·¸ë”°ìœ„ ëˆê¸°ë¡œ ì‚´ë‹¤ê°€ëŠ” ì§„ì§œ ìª½ë°• ì°¬ë‹¤.



# 3. 2026ë…„ ìœ„ê¸° ê²½ê³ 

(ë³‘ì˜¤ë…„ ë¶ˆì˜ í•´ì— ë‹¥ì¹  êµ¬ì²´ì  ìœ„ê¸° ê²½ê³ . ìµœì†Œ 4ë¬¸ì¥ ì´ìƒ ê¸¸ê²Œ ì‘ì„±.)

(ë¬¸ì¥ë§ˆë‹¤ ì¤„ë°”ê¿ˆ í•„ìˆ˜.)



# 4. ì‚´ê³  ì‹¶ìœ¼ë©´ ì´ 3ê°€ì§€ëŠ” í•´ë¼
(í˜„ì‹¤ì ì¸ í–‰ë™ ê°•ë ¹ 3ê°€ì§€. ë²ˆí˜¸ ë§¤ê²¨ì„œ ì‘ì„±. ê° í•­ëª©ë§ˆë‹¤ êµ¬ì²´ì ì¸ ì„¤ëª… 2ì¤„ ì´ìƒ. ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ì¤„ë°”ê¿ˆì„ í•´ì„œ ì½ê¸° í¸í•˜ê²Œ í•´ë¼)
(ê° í•­ëª©ì€ '1.', '2.', '3.'ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•œë‹¤.)
1. ...
2. ...
3. ...



# 5. ì´ê±´ ë¹„ë°€ì¸ë°...

(ìœ ë£Œ ë¦¬í¬íŠ¸ ì˜ˆê³ . í˜¸ê¸°ì‹¬ ìê·¹. ê¸¸ê²Œ ì‘ì„±.)

(êµ¬ì²´ì ì¸ 'ëª‡ ì›”'ì¸ì§€ëŠ” ì ˆëŒ€ ë§í•˜ì§€ ë§ê³  ë¹„ë°€ ë¦¬í¬íŠ¸ë¡œ ìœ ë„í•´ë¼.)

ì˜ˆ:

ë‚´ê°€ íŠ¹ì •í•œ ì‹œê¸°ì— ëŒ€í•´ ë§í•  ìˆ˜ ì—†ì–´ì„œ ì•„ì‰½ë‹¤.

ë„ˆì˜ ì¸ìƒì— ì¤‘ìš”í•œ ì „í™˜ì ì´ ë‹¤ê°€ì˜¤ê³  ìˆê¸° ë•Œë¬¸ì´ì§€.

ë‚´ê°€ ë§í•´ì£¼ì§€ ì•ŠëŠ” ìœ ì¼í•œ ì´ìœ ëŠ” ë„¤ê°€ ì¤€ë¹„ê°€ ë˜ì–´ ìˆì§€ ì•Šê¸° ë•Œë¬¸ì´ì•¼.

ë¯¸ë¦¬ ì¤€ë¹„í•˜ê³  ì‹¶ìœ¼ë©´ ë¦¬í¬íŠ¸ë¥¼ ì—´ì–´ë´.

í›„íšŒí•˜ì§€ ì•Šë„ë¡, ë°˜ë“œì‹œ ì¡°ì‹¬í•´ì•¼ í•  ì‹œê¸°ë¥¼ ë†“ì¹˜ì§€ ë§ì•„ë¼.



---$$$---



# 2026 ì‹œí¬ë¦¿ ë¦¬í¬íŠ¸



## 1. 2026ë…„ ì¢…í•© ì ìˆ˜

(100ì  ë§Œì  ì¤‘ ëª‡ ì ì¸ì§€, ê·¸ë¦¬ê³  ê·¸ ì´ìœ ë¥¼ ìƒì„¸íˆ ì„œìˆ . 5ë¬¸ì¥ ì´ìƒ.)



## 2. ë¶„ê¸°ë³„ ìš´ì„¸ íë¦„

(ê° ë¶„ê¸°ë³„ë¡œ 3ë¬¸ì¥ ì´ìƒ ìƒì„¸í•˜ê²Œ ì„œìˆ )

* **1ë¶„ê¸° (1~3ì›”):** ...

* **2ë¶„ê¸° (4~6ì›”):** ...

* **3ë¶„ê¸° (7~9ì›”):** ...

* **4ë¶„ê¸° (10~12ì›”):** ...



## 3. ê²°ì •ì  íƒ€ì´ë°

* **ğŸš¨ ìµœì•…ì˜ ë‹¬:** (ëª‡ ì›”ì¸ì§€, ì™œ ìœ„í—˜í•œì§€, ì–´ë–»ê²Œ í”¼í•´ì•¼ í•˜ëŠ”ì§€ ìƒì„¸ ì„œìˆ )

* **ğŸ’ ëŒ€ë°•ì˜ ë‹¬:** (ëª‡ ì›”ì¸ì§€, ì–´ë–¤ ê¸°íšŒê°€ ì˜¤ëŠ”ì§€ ìƒì„¸ ì„œìˆ )



## 4. ì‹¬ì¸µ ë¶„ì„

(ê° í•­ëª© 3ë¬¸ì¥ ì´ìƒ)

* **ğŸ’° ì¬ë¬¼ìš´:** (êµ¬ì²´ì ì¸ íˆ¬ì/ì €ì¶• ì „ëµ)

* **ğŸ’¼ ì§ì¥/í•™ì—…:** (ì´ì§/ìŠ¹ì§„/í•©ê²© ì „ëµ)

* **â¤ï¸ ì—°ì• /ì¸ê°„ê´€ê³„:** (ê·€ì¸ê³¼ ì•…ì—° êµ¬ë³„ë²•)



## 5. í–‰ìš´ì˜ ì•„ì´í…œ

* **ìƒ‰ìƒ:**

* **ìˆ«ì:**

* **ë°©í–¥:**

* **í•„ìˆ˜í…œ:**



## 6. ì í† ë§ˆì˜ ë§ˆì§€ë§‰ ë‹¹ë¶€

(ì§„ì •ì„± ìˆëŠ” ê¸´ ì¡°ì–¸. 5ë¬¸ì¥ ì´ìƒ.)`;

    // OpenAI API í˜¸ì¶œ
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: systemPrompt,
        },
        {
          role: 'user',
          content: userPrompt,
        },
      ],
      temperature: 0.9,
      max_tokens: 3000,
    });

    const fortuneText = completion.choices[0]?.message?.content || '';

    if (!fortuneText) {
      return NextResponse.json(
        { error: 'ìš´ì„¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' },
        { status: 500 }
      );
    }

    // Markdown í…ìŠ¤íŠ¸ ë°˜í™˜
    return NextResponse.json({
      fortune: fortuneText,
      saju: {
        heavenlyStems: saju.heavenlyStems,
        earthlyBranches: saju.earthlyBranches,
        fiveElements: saju.fiveElements,
        age: saju.age,
        zodiac: saju.zodiac,
      },
    });
  } catch (error) {
    console.error('ìš´ì„¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    return NextResponse.json(
      { error: 'ìš´ì„¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', details: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    );
  }
}

